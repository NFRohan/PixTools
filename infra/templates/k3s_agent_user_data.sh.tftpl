#!/bin/bash
set -euo pipefail

exec > >(tee /var/log/pixtools-bootstrap.log | logger -t pixtools-bootstrap) 2>&1

trap 'echo "Bootstrap FAILED at line $${LINENO}" >&2' ERR

# ---- Variables injected by Terraform ----
AWS_REGION="${aws_region}"
CLUSTER_NAME="${cluster_name}"
SSM_PREFIX="${ssm_prefix}"
K3S_TOKEN="${k3s_token}"

echo "=== K3s AGENT bootstrap for $${CLUSTER_NAME} in $${AWS_REGION} ==="

# ---- SSM Agent ----
yum install -y amazon-ssm-agent || true
systemctl enable amazon-ssm-agent || true
systemctl restart amazon-ssm-agent || systemctl start amazon-ssm-agent || true

# ---- System packages ----
yum update -y
yum install -y jq unzip tar awscli

# ---- Wait for K3s server to be ready ----
echo "Waiting for K3s server to be ready..."
MAX_WAIT=600
ELAPSED=0
K3S_SERVER_URL=""

while [ $${ELAPSED} -lt $${MAX_WAIT} ]; do
  SERVER_READY="$(aws ssm get-parameter \
    --name "$${SSM_PREFIX}/k3s_server_ready" \
    --query "Parameter.Value" \
    --output text \
    --region "$${AWS_REGION}" 2>/dev/null || echo "false")"

  if [ "$${SERVER_READY}" = "true" ]; then
    K3S_SERVER_URL="$(aws ssm get-parameter \
      --name "$${SSM_PREFIX}/k3s_server_url" \
      --query "Parameter.Value" \
      --output text \
      --region "$${AWS_REGION}")"

    if [ -n "$${K3S_SERVER_URL}" ] && [ "$${K3S_SERVER_URL}" != "PENDING" ]; then
      echo "Server ready at $${K3S_SERVER_URL}"
      break
    fi
  fi

  echo "Server not ready yet ($${ELAPSED}s / $${MAX_WAIT}s)..."
  sleep 10
  ELAPSED=$((ELAPSED + 10))
done

if [ -z "$${K3S_SERVER_URL}" ] || [ "$${K3S_SERVER_URL}" = "PENDING" ]; then
  echo "FATAL: K3s server did not become ready after $${MAX_WAIT}s" >&2
  exit 1
fi

# ---- Get instance metadata ----
IMDS_TOKEN="$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" || true)"
if [ -n "$${IMDS_TOKEN}" ]; then
  INSTANCE_ID="$(curl -s -H "X-aws-ec2-metadata-token: $${IMDS_TOKEN}" http://169.254.169.254/latest/meta-data/instance-id)"
  AVAILABILITY_ZONE="$(curl -s -H "X-aws-ec2-metadata-token: $${IMDS_TOKEN}" http://169.254.169.254/latest/meta-data/placement/availability-zone)"
else
  INSTANCE_ID="$(curl -s http://169.254.169.254/latest/meta-data/instance-id)"
  AVAILABILITY_ZONE="$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)"
fi
PROVIDER_ID="aws:///$${AVAILABILITY_ZONE}/$${INSTANCE_ID}"

# ---- Install K3s AGENT ----
echo "Installing K3s agent, joining server at $${K3S_SERVER_URL}..."
curl -sfL https://get.k3s.io | \
  INSTALL_K3S_CHANNEL=stable \
  K3S_URL="$${K3S_SERVER_URL}" \
  K3S_TOKEN="$${K3S_TOKEN}" \
  INSTALL_K3S_EXEC="agent \
    --kubelet-arg=provider-id=$${PROVIDER_ID} \
    --node-label=pixtools-workload-app=true" \
  sh -

echo "K3s agent installed and joined cluster."

# NOTE: Spot interruption handling is managed by the AWS Node Termination
# Handler (NTH) DaemonSet deployed via k8s/monitoring/aws-node-termination-handler.yaml.
# NTH listens to IMDS for the 2-minute warning and gracefully cordons + drains
# the node at the Kubernetes level â€” no custom systemd service needed.

echo "=== K3s AGENT bootstrap complete ==="

